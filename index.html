<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HADES 100% Completion Checklist</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="cookieManager.js"></script> <!-- Include the cookie manager -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #1A1A1A;
            color: #FFFFFF;
            font-family: 'Merriweather', serif;
            margin: 0;
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            width: 100%;
        }
        h1 {
            color: #E63946;
            text-align: center;
            margin-bottom: 20px;
        }
        .collapsible {
            background-color: #E63946;
            color: white;
            padding: 15px;
            border: none;
            border-radius: 5px;
            text-align: left;
            outline: none;
            font-size: 15px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 5px;
        }
        .collapsible:hover {
            background-color: #D62828;
        }
        .content {
            padding: 10px;
            background-color: #2B2D42;
            border: 1px solid #8D99AE;
            border-radius: 5px;
            margin-bottom: 10px;
            display: none;
        }
        .item {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            margin-bottom: 5px;
            gap: 10px;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        input[type="checkbox"] {
            margin-right: 5px;
        }
        label {
            font-size: 14px;
        }
        .checkbox-number {
            font-size: 12px;
        }
        #checklist-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #total-completion {
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>HADES 100% Completion Checklist</h1>
        <p id="total-completion">Total Completion: 0%</p>
        <div id="checklist-container"></div>
    </div>

    <script>
        $(document).ready(function() {
            fetch('data.xlsx').then(response => response.arrayBuffer()).then(data => {
                const workbook = XLSX.read(data, {type: 'array'});
                processWorkbook(workbook);
                if (loadChecklist()) {
                    updateTotalCompletion(); // Update total completion after loading checklist
                }
            }).catch(error => {
                console.error('Error fetching the Excel file:', error);
            });
        });

        function processWorkbook(workbook) {
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
            generateChecklist(rows);
        }

        function generateChecklist(rows) {
            const container = $('#checklist-container');
            container.empty();
            let sectionCount = 0;
            let totalSections = 0;

            while (rows[0][sectionCount * 2] !== undefined) {
                totalSections++;
                sectionCount++;
            }

            sectionCount = 0;

            while (rows[0][sectionCount * 2] !== undefined) {
                const sectionTitle = rows[0][sectionCount * 2];
                const sectionContent = $('<div class="content"></div>');
                const section = $('<button class="collapsible"></button>').text(`${sectionTitle} (0%)`);
                section.on('click', function() {
                    $(this).next('.content').toggle();
                });

                const items = {};
                for (let i = 1; i < rows.length; i++) {
                    const item = rows[i][sectionCount * 2];
                    const numOfCheckboxes = rows[i][sectionCount * 2 + 1];
                    if (!item) break;
                    if (!items[item]) {
                        items[item] = numOfCheckboxes;
                    } else {
                        items[item] += numOfCheckboxes;
                    }
                }

                const itemContainer = $('<div></div>');
                Object.keys(items).forEach((item, index) => {
                    const numOfCheckboxes = items[item];
                    const itemDiv = $('<div class="item"></div>');
                    const itemLabel = $(`<label>${item}</label>`);
                    const checkboxContainer = $('<div class="checkbox-container"></div>');

                    for (let j = 1; j <= numOfCheckboxes; j++) {
                        const checkbox = $(`<input type="checkbox" class="checkbox-${sectionCount}-${index}-${j}" data-section="${sectionCount}" data-item="${index}" data-num="${j}">`);
                        checkbox.on('change', function() {
                            updateCompletion();
                            saveChecklist(document.querySelectorAll('#checklist-container input[type="checkbox"]')); // Save checklist on change
                        });
                        checkboxContainer.append(checkbox);
                    }

                    itemDiv.append(itemLabel).append(checkboxContainer);
                    itemContainer.append(itemDiv);
                });

                sectionContent.append(itemContainer);
                const sectionPercentage = (100 / Object.keys(items).length).toFixed(2);
                section.attr('data-percentage', sectionPercentage);
                section.attr('data-section', sectionCount);
                container.append(section);
                container.append(sectionContent);

                sectionCount++;
            }
        }

        function updateCompletion() {
            const sectionIndex = $(this).data('section');
            const itemIndex = $(this).data('item');
            const checkboxNum = $(this).data('num');

            if ($(this).is(':checked')) {
                for (let i = 1; i <= checkboxNum; i++) {
                    $(`.checkbox-${sectionIndex}-${itemIndex}-${i}`).prop('checked', true);
                }
            } else {
                for (let i = checkboxNum; i <= $(`input[data-section="${sectionIndex}"][data-item="${itemIndex}"]`).length; i++) {
                    $(`.checkbox-${sectionIndex}-${itemIndex}-${i}`).prop('checked', false);
                }
            }

            updateSectionCompletion(sectionIndex);
            updateTotalCompletion();
        }

        function updateSectionCompletion(sectionIndex) {
            const sectionButton = $(`button[data-section="${sectionIndex}"]`);
            const checkboxes = $(`input[data-section="${sectionIndex}"]`);
            const checkedCheckboxes = checkboxes.filter(':checked').length;
            const totalCheckboxes = checkboxes.length;
            const sectionCompletion = ((checkedCheckboxes / totalCheckboxes) * 100).toFixed(2);
            sectionButton.text(`${sectionButton.text().split(' ')[0]} (${sectionCompletion}%)`);
        }

        function updateTotalCompletion() {
            let totalCompletion = 0;
            const sections = $('button.collapsible');
            const totalSections = sections.length;

            sections.each(function() {
                const sectionCompletion = parseFloat($(this).text().match(/\(([^)]+)%\)/)[1]);
                totalCompletion += sectionCompletion / totalSections;
            });

            $('#total-completion').text(`Total Completion: ${totalCompletion.toFixed(2)}%`);
        }
    </script>
</body>
</html>
